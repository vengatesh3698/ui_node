{"version":3,"file":"VaInfiniteScroll.vue_vue_type_script_lang.js","sources":["../../../../../src/components/va-infinite-scroll/VaInfiniteScroll.vue"],"sourcesContent":["<template>\n  <component\n    :is=\"$props.tag as 'div'\"\n    ref=\"element\"\n    role=\"feed\"\n    class=\"va-infinite-scroll\"\n    :class=\"{ 'va-infinite-scroll--reversed': $props.reverse }\"\n    :aria-busy=\"fetching\"\n  >\n    <slot name=\"default\" />\n\n    <div\n      ref=\"spinnerSlotContainer\"\n      class=\"va-infinite-scroll__spinner\"\n      :class=\"{ 'va-infinite-scroll__spinner--invisible': !fetching }\"\n    >\n      <slot\n        v-if=\"!$props.disabled\"\n        name=\"loading\"\n      >\n        <div class=\"va-infinite-scroll__spinner__default\">\n          <va-progress-circle\n            size=\"small\"\n            :thickness=\"0.15\"\n            :color=\"spinnerColor\"\n            indeterminate\n          />\n        </div>\n      </slot>\n    </div>\n  </component>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent, PropType, ref, shallowRef, watch } from 'vue'\nimport debounce from 'lodash/debounce.js'\n\nimport { sleep } from '../../utils/sleep'\nimport { useColors } from '../../composables'\nimport { useScroll } from './hooks/useScroll'\n\nimport { VaProgressCircle } from '../va-progress-circle'\nimport { useComponentPresetProp } from '../../composables/useComponentPreset'\n\nexport default defineComponent({\n  name: 'VaInfiniteScroll',\n\n  components: { VaProgressCircle },\n\n  props: {\n    ...useComponentPresetProp,\n    load: { type: Function, required: true },\n    offset: { type: Number, default: 500 },\n    reverse: { type: Boolean, default: false },\n    disabled: { type: Boolean, default: false },\n    scrollTarget: { type: [String, Object] as PropType<string | HTMLElement>, default: undefined },\n    debounce: { type: Number, default: 100 },\n    tag: { type: String, default: 'div' },\n  },\n\n  emits: ['onload', 'onerror'],\n\n  setup (props, { emit }) {\n    const element = shallowRef<HTMLElement>()\n    const spinnerSlotContainer = shallowRef<HTMLDivElement>()\n\n    const fetching = ref(false)\n    const error = ref(false)\n    const forcedScrolling = ref(false)\n    const debouncedLoad = ref()\n    const notScrolledContentBeforeLoad = ref(0)\n    const prevScrollTop = ref(0)\n\n    const scrollTargetElement = computed<HTMLElement>(() => {\n      let target\n\n      if (typeof props.scrollTarget === 'string') {\n        target = document.querySelector(props.scrollTarget)\n      } else {\n        target = props.scrollTarget || element.value?.parentElement\n      }\n\n      return (target || document.body) as HTMLElement\n    })\n\n    const {\n      addScrollListener,\n      removeScrollListener,\n    } = useScroll(props, scrollTargetElement, debouncedLoad)\n\n    const { getColor } = useColors()\n\n    const spinnerColor = computed(() => {\n      return error.value ? getColor('danger') : getColor('primary')\n    })\n\n    const spinnerHeight = computed(() => {\n      return spinnerSlotContainer.value?.offsetHeight || 0\n    })\n\n    const computedOffset = computed(() => {\n      return props.offset + spinnerHeight.value\n    })\n\n    const stop = () => {\n      if (props.disabled) { return }\n\n      fetching.value = false\n      removeScrollListener()\n    }\n\n    const resume = () => {\n      if (props.disabled) { return }\n\n      addScrollListener()\n    }\n\n    const onLoad = () => {\n      const { scrollTop, scrollHeight, clientHeight } = scrollTargetElement.value\n      notScrolledContentBeforeLoad.value = scrollHeight - scrollTop\n      const scrollDelta = scrollTop - prevScrollTop.value\n      prevScrollTop.value = scrollTop\n\n      if (props.disabled || error.value || fetching.value) { return }\n\n      if (forcedScrolling.value) {\n        forcedScrolling.value = false\n        return\n      }\n\n      const isReverseScrollDirection = (props.reverse && scrollDelta > 0) || (!props.reverse && scrollDelta < 0)\n      if (isReverseScrollDirection) { return }\n\n      const offset = props.reverse ? scrollTop : scrollHeight - scrollTop - clientHeight\n      if (offset > computedOffset.value) { return }\n\n      fetching.value = true\n\n      props.load()\n        .then(finishLoading)\n        .catch(onError)\n    }\n\n    const forceSetScrollTopToTarget = (value: number) => {\n      forcedScrolling.value = true\n      scrollTargetElement.value.scrollTop = value\n    }\n\n    const updateTargetElementScrollTop = () => {\n      const { scrollTop, scrollHeight, clientHeight } = scrollTargetElement.value\n\n      if (props.reverse) {\n        const isScrolledUp = scrollHeight - scrollTop < notScrolledContentBeforeLoad.value\n        const isSpinnerHidden = scrollTop >= spinnerHeight.value\n\n        if (isScrolledUp && isSpinnerHidden) { return }\n\n        (scrollHeight - notScrolledContentBeforeLoad.value > spinnerHeight.value)\n          ? forceSetScrollTopToTarget(scrollHeight - notScrolledContentBeforeLoad.value)\n          : forceSetScrollTopToTarget(spinnerHeight.value)\n      }\n\n      if (!props.reverse) {\n        const isSpinnerHidden = scrollHeight - scrollTop - clientHeight >= spinnerHeight.value\n        !isSpinnerHidden && forceSetScrollTopToTarget(scrollHeight - clientHeight - spinnerHeight.value)\n      }\n    }\n\n    const finishLoading = () => {\n      updateTargetElementScrollTop()\n      fetching.value = false\n      emit('onload')\n    }\n\n    const stopErrorDisplay = () => {\n      updateTargetElementScrollTop()\n      forcedScrolling.value = false\n      error.value = false\n      fetching.value = false\n      emit('onerror')\n    }\n\n    const onError = () => {\n      stop()\n      error.value = true\n\n      sleep(1200)\n        .then(stopErrorDisplay)\n        .then(resume)\n    }\n\n    watch(() => props.debounce, (value) => {\n      debouncedLoad.value = debounce(onLoad, value)\n    }, { immediate: true })\n\n    watch(() => props.disabled, (value) => {\n      value ? stop() : resume()\n    })\n\n    return {\n      element,\n      spinnerSlotContainer,\n\n      spinnerColor,\n      fetching,\n    }\n  },\n})\n</script>\n\n<style lang=\"scss\">\n@import \"../../styles/resources\";\n@import 'variables';\n\n.va-infinite-scroll {\n  display: var(--va-infinite-scroll-display);\n  flex-direction: var(--va-infinite-scroll-flex-direction);\n  font-family: var(--va-font-family);\n\n  &--reversed {\n    flex-direction: var(--va-infinite-scroll-reversed-flex-direction);\n  }\n\n  &__spinner {\n    &__default {\n      @include flex-center();\n\n      width: var(--va-infinite-scroll-spinner-default-width);\n      min-height: var(--va-infinite-scroll-spinner-default-min-height);\n    }\n\n    &--invisible {\n      visibility: hidden !important;\n    }\n\n    @include flex-center();\n  }\n}\n</style>\n"],"names":[],"mappings":"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"}