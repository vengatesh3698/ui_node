{"version":3,"file":"VaImage.js","sources":["../../../../../src/components/va-image/VaImage.vue"],"sourcesContent":["<template>\n  <va-aspect-ratio\n    ref=\"root\"\n    class=\"va-image\"\n    v-bind=\"aspectRationAttributesComputed\"\n  >\n    <picture\n      v-show=\"isSuccessfullyLoaded\"\n      class=\"va-image__content\"\n      :aria-busy=\"isLoading\"\n    >\n      <slot v-if=\"$slots.sources\" name=\"sources\" />\n\n      <img\n        v-if=\"isReadyForRender\"\n        ref=\"image\"\n        v-bind=\"imgAttributesComputed\"\n        @error=\"handleError\"\n        @load=\"handleLoad\"\n      />\n    </picture>\n\n    <div\n      v-if=\"$slots.default && isSuccessfullyLoaded\"\n      class=\"va-image__overlay\"\n    >\n      <slot />\n    </div>\n\n    <div\n      v-if=\"isError && ($slots.error || isAnyFallbackPassed)\"\n      class=\"va-image__error\"\n    >\n      <slot name=\"error\">\n        <va-fallback v-bind=\"fallbackProps\" @fallback=\"$emit('fallback')\" />\n      </slot>\n    </div>\n\n    <div\n      v-if=\"isLoading && $slots.loader\"\n      class=\"va-image__loader\"\n    >\n      <slot name=\"loader\" />\n    </div>\n\n    <div\n      v-if=\"isPlaceholderShown\"\n      class=\"va-image__placeholder\"\n    >\n      <slot name=\"placeholder\">\n        <img\n          v-if=\"$props.placeholderSrc\"\n          :src=\"$props.placeholderSrc\"\n          alt=\"\"\n        />\n      </slot>\n    </div>\n  </va-aspect-ratio>\n</template>\n\n<script lang=\"ts\">\nimport {\n  defineComponent,\n  ref,\n  computed,\n  watch,\n  nextTick,\n  onBeforeMount,\n  onBeforeUnmount,\n  type PropType,\n} from 'vue'\nimport pick from 'lodash/pick.js'\n\nimport { VaAspectRatio } from '../va-aspect-ratio'\nimport { VaFallback } from '../va-fallback'\n\nimport { useNativeImgAttributes, useNativeImgAttributesProps } from './hooks/useNativeImgAttributes'\nimport {\n  useComponentPresetProp,\n  useIsMounted,\n  useDeprecated,\n  useIntersectionObserver,\n  useGlobalConfig,\n} from '../../composables'\n\nimport { extractComponentProps, filterComponentProps } from '../../utils/component-options'\n\nconst VaFallbackProps = extractComponentProps(VaFallback)\n\nexport default defineComponent({\n  name: 'VaImage',\n\n  components: { VaAspectRatio, VaFallback },\n\n  emits: ['loaded', 'error', 'fallback'],\n\n  props: {\n    ...useComponentPresetProp,\n    ...useNativeImgAttributesProps,\n    ...VaFallbackProps,\n    ratio: {\n      type: [Number, String] as PropType<number | 'auto'>,\n      default: 'auto',\n      validator: (v: number | 'auto') => {\n        if (typeof v === 'number') {\n          return v > 0\n        }\n\n        return v === 'auto'\n      },\n    },\n    fit: {\n      type: String as PropType<'contain' | 'fill' | 'cover' | 'scale-down' | 'none'>,\n      default: 'cover',\n    },\n    maxWidth: {\n      type: Number,\n      default: 0,\n      validator: (v: number) => v >= 0,\n    },\n    lazy: { type: Boolean, default: false },\n    placeholderSrc: { type: String, default: '' },\n    // TODO: delete in 1.7.0\n    contain: { type: Boolean, default: false },\n  },\n\n  setup (props, { emit, slots }) {\n    // TODO: delete in 1.7.0\n    useDeprecated(['contain'])\n\n    const root = ref<HTMLElement>()\n    const image = ref<HTMLImageElement>()\n\n    const renderedImage = ref()\n    const currentImage = computed(() => renderedImage.value || props.src)\n\n    const imgWidth = ref(1)\n    const imgHeight = ref(1)\n\n    const isLoading = ref(false)\n    const isError = ref(false)\n\n    const handleLoad = () => {\n      isLoading.value = true\n\n      if (!isReadyForLoad.value) { return }\n\n      isLoading.value = false\n\n      renderedImage.value = image.value?.currentSrc\n      getImgSizes()\n\n      emit('loaded', currentImage.value)\n    }\n\n    const handleError = (err?: Event) => {\n      isError.value = true\n      isLoading.value = false\n\n      emit('error', err || currentImage.value)\n    }\n\n    const isIntersecting = ref(false)\n    const handleIntersection = (entries: IntersectionObserverEntry[], observer: IntersectionObserver) => {\n      entries.forEach((entry) => {\n        if (!entry.isIntersecting) { return }\n\n        isIntersecting.value = true\n        init()\n        observer.disconnect()\n      })\n    }\n    const { isIntersectionDisabled } = useIntersectionObserver(handleIntersection, undefined, root, props.lazy)\n    const isReadyForLoad = computed(() => isIntersectionDisabled.value || isIntersecting.value)\n    const isMounted = useIsMounted()\n    const isReadyForRender = computed(() => !props.lazy || (props.lazy && isMounted.value && isReadyForLoad.value))\n\n    const init = () => {\n      if (!props.src || (isLoading.value && isIntersectionDisabled.value) || !isReadyForLoad.value) {\n        return\n      }\n\n      isLoading.value = true\n      isError.value = false\n\n      nextTick(() => {\n        if (!image.value?.complete) {\n          return\n        }\n\n        if (!image.value.naturalWidth) {\n          handleError()\n          return\n        }\n\n        handleLoad()\n      })\n    }\n\n    let timer: ReturnType<Window['setTimeout']>\n    const getImgSizes = () => {\n      clearTimeout(timer)\n\n      if (isLoading.value) {\n        timer = window.setTimeout(getImgSizes, 100)\n      }\n\n      const { naturalHeight, naturalWidth } = image.value || {}\n      if (naturalHeight && naturalWidth) {\n        imgWidth.value = naturalHeight\n        imgHeight.value = naturalWidth\n      }\n    }\n\n    onBeforeMount(init)\n    onBeforeUnmount(() => clearTimeout(timer))\n    watch(() => props.src, init)\n\n    const isPlaceholderPassed = computed(() => slots?.placeholder?.() || props.placeholderSrc)\n    const isLoaderShown = computed(() => isLoading.value && !slots?.loader?.())\n    const isErrorShown = computed(() => isError.value && (!slots?.error?.() && !isAnyFallbackPassed.value))\n    const isPlaceholderShown = computed(() => (isLoaderShown.value || isErrorShown.value) && isPlaceholderPassed.value)\n\n    const isSuccessfullyLoaded = computed(() => !(isLoading.value || isError.value))\n\n    const imgAttributesComputed = useNativeImgAttributes(props)\n\n    const aspectRationAttributesComputed = computed(() => ({\n      ...pick(props, ['ratio', 'maxWidth']),\n      contentWidth: imgWidth.value,\n      contentHeight: imgHeight.value,\n    }))\n\n    const fallbackProps = filterComponentProps(VaFallbackProps)\n    const checkObjectNonEmptyValues = (obj: Record<string, any> | undefined) => !!Object.values(obj || {}).filter((prop) => prop).length\n    const hasFallbackGlobalConfig = computed(() => checkObjectNonEmptyValues(useGlobalConfig()?.globalConfig?.value?.components?.VaFallback))\n    const isAnyFallbackPassed = computed(() => checkObjectNonEmptyValues(fallbackProps.value) || hasFallbackGlobalConfig.value)\n\n    // TODO: refactor (just v-bind fit prop to CSS) in 1.7.0\n    const fitComputed = computed(() => {\n      if (props.contain) { return 'contain' }\n      return props.fit\n    })\n\n    return {\n      fitComputed,\n\n      root,\n      image,\n\n      isLoading,\n      handleLoad,\n      isError,\n      handleError,\n      isReadyForRender,\n\n      isPlaceholderShown,\n      isSuccessfullyLoaded,\n      imgAttributesComputed,\n      aspectRationAttributesComputed,\n\n      isAnyFallbackPassed,\n      fallbackProps,\n    }\n  },\n})\n</script>\n\n<style lang=\"scss\">\n@import 'variables';\n\n.va-image {\n  &__content {\n    position: var(--va-image-content-position);\n    inset: 0;\n    width: 100%;\n\n    img {\n      width: 100%;\n      height: 100%;\n      object-fit: v-bind(fitComputed);\n      object-position: var(--va-image-content-img-object-position);\n    }\n  }\n\n  &__overlay {\n    position: absolute;\n    inset: 0;\n  }\n\n  &__placeholder,\n  &__loader,\n  &__error,\n  &__overlay {\n    width: 100%;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  }\n}\n</style>\n"],"names":["_resolveComponent","_openBlock","_createBlock","_mergeProps","_withCtx","_withDirectives","_createElementVNode","_renderSlot","_createCommentVNode","_createElementBlock","_vShow","_createVNode"],"mappings":";;;;;MAwBM,aAAM;AAAA,EAAA,KAAA;AAAA;;MAON,aAAM;AAAA,EAAA,KAAA;AAAA;;MASN,aAAM;AAAA,EAAA,KAAA;AAAA;;MAON,aAAM;AAAA,EAAA,KAAA;AAAA;;;;;qCAUQA,iBAxDlB,iBAAA;SAEOC,UAAW,GAAAC,YAAA,4BAAAC,WAAA;AAAA,IACR,KAAA;AAAA,IAAA,OAAA;AAAA,wCAER,GAcU;AAAA,IAAA,SAZHC,QAAC,MAAA;AAAA,MAAAC,eACMC,mBAAS,WAAA;AAAA,QAAA,OAAA;AAAA,QAEF,aAAA,KAAA;AAAA,MAAA,GAAA;AAAA,QAGX,KAAA,OAAA,UAAAC,WAAA,KAAA,QAAgB,WADxB,EAAA,KAAA,EAAA,CAAA,IAAAC,mBAAA,IAAA,IAAA;AAAA,QAAA,KAAA,oBAAAP,UAAA,GAEaQ,mBAAA,OAAAN,WAAA;AAAA,UACH,KAAA;AAAA,UACP,KAAA;AAAA,QAAA,GACA,KAAI,uBAAA;AAAA,UAAA,SAAA,OAAA,CAAA,MAAA,OAAA,CAAA,IAAA,IAAA,SAAA,KAAA,eAAA,KAAA,YAAA,GAAA,IAAA;AAAA;QAXC,CAAA,GAAA,MAAA,EAAA,KAAAK,mBAAA,IAAA,IAAA;AAAA,MAAA,GAAA,GAAA,UAAA,GAAA;AAAA,QAgBF,CAAAE,OAAA,KAAO,oBAAW;AAAA,MAAA,CAAA;AAAA,WAGxB,OAAQ,WAAA,KAAA,wBAAAT,aAAAQ,mBAAA,OAAA,YAAA;AAAA;OAGV,KAAAD,mBAAA,IAAA,IAAA;AAAA,MAAA,KAIE,YAEO,KAAA,OAAA,SAAA,KAFP,wBACEP,UAAA,GAAAQ,mBAAoE,OAApE,YAAoE;AAAA,QAAAF,WAA/B,KAAQ,QAAA,SAAA,CAAA,GAAA,MAAA;AAAA,UAAAI,YAAA,wBAAAR,WAAA,KAAA,eAAA;AAAA;;;OAIjD,KAAAK,mBAAA,IAAA,IAAA;AAAA,MAAA,KAIE,aAAsB,KAAA,OAAA,UAAAP,aAAAQ,mBAAA,OAAA,YAAA;AAAA;OAGxB,KAAAD,mBAAA,IAAA,IAAA;AAAA,MAAA,KAIE,mCAE+BC,mBAAA,OAAA,YAAA;AAAA,QAAAF,WAAA,KAAA,QAD7B,eAIE,CAAA,GAAA,MAAA;AAAA,UAAA,KAAA,OAAA,kBAAAN,UAAA,GAF2BQ,mBAAA,OAAA;AAAA,YAC3B,KAAI;AAAA,YAAA,KAAA,KAAA,OAAA;AAAA;;;;;;;;;"}