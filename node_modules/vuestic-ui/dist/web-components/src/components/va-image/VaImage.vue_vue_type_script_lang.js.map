{"version":3,"file":"VaImage.vue_vue_type_script_lang.js","sources":["../../../../../src/components/va-image/VaImage.vue"],"sourcesContent":["<template>\n  <va-aspect-ratio\n    ref=\"root\"\n    class=\"va-image\"\n    v-bind=\"aspectRationAttributesComputed\"\n  >\n    <picture\n      v-show=\"isSuccessfullyLoaded\"\n      class=\"va-image__content\"\n      :aria-busy=\"isLoading\"\n    >\n      <slot v-if=\"$slots.sources\" name=\"sources\" />\n\n      <img\n        v-if=\"isReadyForRender\"\n        ref=\"image\"\n        v-bind=\"imgAttributesComputed\"\n        @error=\"handleError\"\n        @load=\"handleLoad\"\n      />\n    </picture>\n\n    <div\n      v-if=\"$slots.default && isSuccessfullyLoaded\"\n      class=\"va-image__overlay\"\n    >\n      <slot />\n    </div>\n\n    <div\n      v-if=\"isError && ($slots.error || isAnyFallbackPassed)\"\n      class=\"va-image__error\"\n    >\n      <slot name=\"error\">\n        <va-fallback v-bind=\"fallbackProps\" @fallback=\"$emit('fallback')\" />\n      </slot>\n    </div>\n\n    <div\n      v-if=\"isLoading && $slots.loader\"\n      class=\"va-image__loader\"\n    >\n      <slot name=\"loader\" />\n    </div>\n\n    <div\n      v-if=\"isPlaceholderShown\"\n      class=\"va-image__placeholder\"\n    >\n      <slot name=\"placeholder\">\n        <img\n          v-if=\"$props.placeholderSrc\"\n          :src=\"$props.placeholderSrc\"\n          alt=\"\"\n        />\n      </slot>\n    </div>\n  </va-aspect-ratio>\n</template>\n\n<script lang=\"ts\">\nimport {\n  defineComponent,\n  ref,\n  computed,\n  watch,\n  nextTick,\n  onBeforeMount,\n  onBeforeUnmount,\n  type PropType,\n} from 'vue'\nimport pick from 'lodash/pick.js'\n\nimport { VaAspectRatio } from '../va-aspect-ratio'\nimport { VaFallback } from '../va-fallback'\n\nimport { useNativeImgAttributes, useNativeImgAttributesProps } from './hooks/useNativeImgAttributes'\nimport {\n  useComponentPresetProp,\n  useIsMounted,\n  useDeprecated,\n  useIntersectionObserver,\n  useGlobalConfig,\n} from '../../composables'\n\nimport { extractComponentProps, filterComponentProps } from '../../utils/component-options'\n\nconst VaFallbackProps = extractComponentProps(VaFallback)\n\nexport default defineComponent({\n  name: 'VaImage',\n\n  components: { VaAspectRatio, VaFallback },\n\n  emits: ['loaded', 'error', 'fallback'],\n\n  props: {\n    ...useComponentPresetProp,\n    ...useNativeImgAttributesProps,\n    ...VaFallbackProps,\n    ratio: {\n      type: [Number, String] as PropType<number | 'auto'>,\n      default: 'auto',\n      validator: (v: number | 'auto') => {\n        if (typeof v === 'number') {\n          return v > 0\n        }\n\n        return v === 'auto'\n      },\n    },\n    fit: {\n      type: String as PropType<'contain' | 'fill' | 'cover' | 'scale-down' | 'none'>,\n      default: 'cover',\n    },\n    maxWidth: {\n      type: Number,\n      default: 0,\n      validator: (v: number) => v >= 0,\n    },\n    lazy: { type: Boolean, default: false },\n    placeholderSrc: { type: String, default: '' },\n    // TODO: delete in 1.7.0\n    contain: { type: Boolean, default: false },\n  },\n\n  setup (props, { emit, slots }) {\n    // TODO: delete in 1.7.0\n    useDeprecated(['contain'])\n\n    const root = ref<HTMLElement>()\n    const image = ref<HTMLImageElement>()\n\n    const renderedImage = ref()\n    const currentImage = computed(() => renderedImage.value || props.src)\n\n    const imgWidth = ref(1)\n    const imgHeight = ref(1)\n\n    const isLoading = ref(false)\n    const isError = ref(false)\n\n    const handleLoad = () => {\n      isLoading.value = true\n\n      if (!isReadyForLoad.value) { return }\n\n      isLoading.value = false\n\n      renderedImage.value = image.value?.currentSrc\n      getImgSizes()\n\n      emit('loaded', currentImage.value)\n    }\n\n    const handleError = (err?: Event) => {\n      isError.value = true\n      isLoading.value = false\n\n      emit('error', err || currentImage.value)\n    }\n\n    const isIntersecting = ref(false)\n    const handleIntersection = (entries: IntersectionObserverEntry[], observer: IntersectionObserver) => {\n      entries.forEach((entry) => {\n        if (!entry.isIntersecting) { return }\n\n        isIntersecting.value = true\n        init()\n        observer.disconnect()\n      })\n    }\n    const { isIntersectionDisabled } = useIntersectionObserver(handleIntersection, undefined, root, props.lazy)\n    const isReadyForLoad = computed(() => isIntersectionDisabled.value || isIntersecting.value)\n    const isMounted = useIsMounted()\n    const isReadyForRender = computed(() => !props.lazy || (props.lazy && isMounted.value && isReadyForLoad.value))\n\n    const init = () => {\n      if (!props.src || (isLoading.value && isIntersectionDisabled.value) || !isReadyForLoad.value) {\n        return\n      }\n\n      isLoading.value = true\n      isError.value = false\n\n      nextTick(() => {\n        if (!image.value?.complete) {\n          return\n        }\n\n        if (!image.value.naturalWidth) {\n          handleError()\n          return\n        }\n\n        handleLoad()\n      })\n    }\n\n    let timer: ReturnType<Window['setTimeout']>\n    const getImgSizes = () => {\n      clearTimeout(timer)\n\n      if (isLoading.value) {\n        timer = window.setTimeout(getImgSizes, 100)\n      }\n\n      const { naturalHeight, naturalWidth } = image.value || {}\n      if (naturalHeight && naturalWidth) {\n        imgWidth.value = naturalHeight\n        imgHeight.value = naturalWidth\n      }\n    }\n\n    onBeforeMount(init)\n    onBeforeUnmount(() => clearTimeout(timer))\n    watch(() => props.src, init)\n\n    const isPlaceholderPassed = computed(() => slots?.placeholder?.() || props.placeholderSrc)\n    const isLoaderShown = computed(() => isLoading.value && !slots?.loader?.())\n    const isErrorShown = computed(() => isError.value && (!slots?.error?.() && !isAnyFallbackPassed.value))\n    const isPlaceholderShown = computed(() => (isLoaderShown.value || isErrorShown.value) && isPlaceholderPassed.value)\n\n    const isSuccessfullyLoaded = computed(() => !(isLoading.value || isError.value))\n\n    const imgAttributesComputed = useNativeImgAttributes(props)\n\n    const aspectRationAttributesComputed = computed(() => ({\n      ...pick(props, ['ratio', 'maxWidth']),\n      contentWidth: imgWidth.value,\n      contentHeight: imgHeight.value,\n    }))\n\n    const fallbackProps = filterComponentProps(VaFallbackProps)\n    const checkObjectNonEmptyValues = (obj: Record<string, any> | undefined) => !!Object.values(obj || {}).filter((prop) => prop).length\n    const hasFallbackGlobalConfig = computed(() => checkObjectNonEmptyValues(useGlobalConfig()?.globalConfig?.value?.components?.VaFallback))\n    const isAnyFallbackPassed = computed(() => checkObjectNonEmptyValues(fallbackProps.value) || hasFallbackGlobalConfig.value)\n\n    // TODO: refactor (just v-bind fit prop to CSS) in 1.7.0\n    const fitComputed = computed(() => {\n      if (props.contain) { return 'contain' }\n      return props.fit\n    })\n\n    return {\n      fitComputed,\n\n      root,\n      image,\n\n      isLoading,\n      handleLoad,\n      isError,\n      handleError,\n      isReadyForRender,\n\n      isPlaceholderShown,\n      isSuccessfullyLoaded,\n      imgAttributesComputed,\n      aspectRationAttributesComputed,\n\n      isAnyFallbackPassed,\n      fallbackProps,\n    }\n  },\n})\n</script>\n\n<style lang=\"scss\">\n@import 'variables';\n\n.va-image {\n  &__content {\n    position: var(--va-image-content-position);\n    inset: 0;\n    width: 100%;\n\n    img {\n      width: 100%;\n      height: 100%;\n      object-fit: v-bind(fitComputed);\n      object-position: var(--va-image-content-img-object-position);\n    }\n  }\n\n  &__overlay {\n    position: absolute;\n    inset: 0;\n  }\n\n  &__placeholder,\n  &__loader,\n  &__error,\n  &__overlay {\n    width: 100%;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  }\n}\n</style>\n"],"names":[],"mappings":"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"}